let t;const e="items",i="tags";function n(e,i){return t.result.transaction(e,i?"readwrite":"readonly").objectStore(e)}async function o(){return new Promise(t=>{let e=n(i),o=e.getAll();o.onsuccess=function(){let e=o.result;t(e)}})}async function r(){return new Promise(r=>{(t=indexedDB.open("wallet",2)).onupgradeneeded=function(){let n=t.result;n.objectStoreNames.contains(e)||n.createObjectStore(e,{keyPath:"id"}),n.objectStoreNames.contains(i)||n.createObjectStore(i,{keyPath:"id"})},t.onerror=function(){console.error("DB ERROR",t.error)},t.onsuccess=function(){Promise.all([o(),new Promise(t=>{let i=n(e),o=i.getAll();o.onsuccess=function(){let e=o.result;t(e)}})]).then(([t,e])=>{r({tags:t,items:e})})}})}function s(t,e){alert(t),console.info(t,e)}function m(t,e){alert(t),console.error(t,e)}const a={items:"items",tags:"tags"},l={update:"update",add:"add",remove:"remove"},u={items:[],tags:[]},c={items:0,tags:0},d={};function g(t,e,i){let n=d[t];if(!n)return;let o=n[e];o&&o.forEach(t=>t(i))}function f(t,e,i){t in d||(d[t]={}),e in d[t]||(d[t][e]=[]),d[t][e].push(i)}function p(t,e){u[t].push(e),g(t,l.add,e)}function b(t,e){u[t]=u[t].filter(t=>t.id!==e.id),g(t,l.remove,e)}const v={items:{list:"items",template:"item-tmpl",subitemTemplate:"subitem-tmpl"},itemForm:{dialog:"new-item-dialog",form:"new-item-form",addButton:"add-item",closeButton:"close-new-item-dialog",subitemsList:"new-item-form-subitems",tagsSelect:"tags-select",addSubitemBtn:"new-item-add-subitem",subitemTemplate:"subitem-form-tmpl"},tags:{list:"tags",template:"tag-tmpl"},tagForm:{dialog:"new-tag-dialog",form:"new-tag-form",addButton:"add-tag",closeButton:"close-new-tag-dialog"}},S={};function h(t){if(S[t])return S[t];let e=document.getElementById(t);return S[t]=e,e}function x(t){let e=h(t),i=e.content.cloneNode(!0);return i}function F(t){let e=document.createElement("option");return e.textContent=t.name,e.value=t.id,e}function y(){let t=h(v.itemForm.tagsSelect);t.innerHTML="";let e=u[a.tags];e.forEach(e=>{let i=F(e);t.appendChild(i)})}function w(){let t=h(v.itemForm.dialog);t.close(),function(){let t=h(v.itemForm.form),e=h(v.itemForm.subitemsList);t.reset(),e.innerHTML=""}()}const E={item:".item",itemText:".item-text",itemPrice:".item-price",itemTag:".item-tag",itemRemove:".item-remove",subitems:".item-subitems",subitem:".subitem",subitemText:".subitem-text",subitemPrice:".subitem-price",subitemTag:".subitem-tag"};function C(t){let e=x(v.items.template),i=e.querySelector(E.item);i.dataset.itemId=t.id,i.querySelector(E.itemText).textContent=t.text,i.querySelector(E.itemPrice).textContent=t.price;let n=u[a.tags],o=n.find(e=>e.id===t.tag);if(i.querySelector(E.itemTag).textContent=o?.name||"",t.subitems?.length>0){let e=i.querySelector(E.subitems);t.subitems.forEach(t=>{let i=function(t){let e=x(v.items.subitemTemplate),i=e.querySelector(E.subitem);i.querySelector(E.subitemText).textContent=t.text,i.querySelector(E.subitemPrice).textContent=t.price;let n=u[a.tags],o=n.find(e=>e.id===t.tag);return i.querySelector(E.subitemTag).textContent=o?.name||"",i}(t);e.appendChild(i)})}return i}function q(){let t=h(v.tagForm.dialog);t.close(),function(){let t=h(v.tagForm.form);t.reset()}()}const L={tag:".tag",tagName:".tag-name",tagRemove:".tag-remove"};function T(t){let e=x(v.tags.template),i=e.querySelector(L.tag);return i.dataset.tagId=t.id,i.querySelector(L.tagName).textContent=t.name,i}// Subscriptions
f(a.tags,l.update,t=>{(function(t){let e=h(v.tags.list);t.forEach(t=>{let i=T(t);e.appendChild(i)})})(t),y()}),f(a.tags,l.add,t=>{let e;(function(t){let e=h(v.tags.list),i=T(t);e.appendChild(i)})(t),q(),y(),(e=n(i,!0).add(t)).onsuccess=function(){s("Запись успешно сохранена")},e.onerror=function(){m("Не удалось сохранить запись",e.error)}}),f(a.tags,l.remove,t=>{let e;(function(t){let e=document.querySelector(`[data-tag-id="${t}"]`);e.remove()})(t.id),y(),(e=n(i,!0).delete(t.id)).onsuccess=function(){s("Запись успешно удалена")},e.onerror=function(){m("Не удалось удалить запись",e.error)}}),f(a.items,l.update,t=>{!function(t){let e=h(v.items.list);t.forEach(t=>{let i=C(t);e.appendChild(i)})}(t)}),f(a.items,l.add,t=>{(function(t){let e=C(t),i=h(v.items.list);i.appendChild(e)})(t),w(),function(t){let i=n(e,!0),o=i.add(t);o.onsuccess=function(){s("Запись успешно сохранена")},o.onerror=function(){m("Не удалось сохранить запись",o.error)}}(t)}),f(a.items,l.remove,t=>{let i;(function(t){let e=document.querySelector(`[data-item-id="${t}"]`);e.remove()})(t.id),(i=n(e,!0).delete(t.id)).onsuccess=function(){s("Запись успешно удалена")},i.onerror=function(){m("Не удалось удалить запись",i.error)}}),r().then(({tags:t,items:e})=>{!function({tags:t,items:e}){t.length>0&&(c.tags=t[t.length-1].id,u.tags=t,g(a.tags,l.update,t)),e.length>0&&(c.items=e[e.length-1].id,u.items=e,g(a.items,l.update,e))}({tags:t,items:e})}),// Init
console.log("init"),function(t){let{onSubmit:e}=t,i=h(v.itemForm.form),n=h(v.itemForm.addButton),o=h(v.itemForm.closeButton),r=h(v.itemForm.addSubitemBtn),s=h(v.itemForm.subitemsList);i.addEventListener("submit",t=>{t.preventDefault(),e(function(){let t=h(v.itemForm.form),e=new FormData(t),i=e.getAll("subitems[text][]"),n=e.getAll("subitems[price][]"),o=e.getAll("subitems[tag][]");return{text:e.get("text"),price:e.get("price"),tag:Number(e.get("tag")),subitems:i.map((t,e)=>({text:t,price:n[e],tag:Number(o[e])}))}}())}),n.addEventListener("click",()=>{!function(){let t=h(v.itemForm.dialog);t.showModal()}()}),o.addEventListener("click",()=>{w()}),r.addEventListener("click",()=>{let t=function(){let t=x(v.itemForm.subitemTemplate),e=t.querySelector(".subitem-form"),i=e.querySelector("select"),n=u[a.tags];return n.forEach(t=>{let e=F(t);i.appendChild(e)}),e}();s.appendChild(t)})}({onSubmit:t=>{var e;let{text:i,price:n,tag:o,subitems:r}=t,s=+new Date,m={id:(e=a.items,++c[e]),text:i,price:n,tag:o,createdAt:s,subitems:r.map(t=>{var e;return{id:(e=a.items,++c[e]),text:t.text,price:t.price,tag:t.tag,createdAt:s}})};p(a.items,m)}}),function(t){let{onSubmit:e}=t,i=h(v.tagForm.form),n=h(v.tagForm.addButton),o=h(v.tagForm.closeButton);console.log(n),i.addEventListener("submit",t=>{t.preventDefault(),e(function(){let t=h(v.tagForm.form);return{name:t.elements.name.value}}())}),n.addEventListener("click",()=>{!function(){let t=h(v.tagForm.dialog);t.showModal()}()}),o.addEventListener("click",()=>{q()})}({onSubmit:t=>{var e;let{name:i}=t,n={id:(e=a.tags,++c[e]),name:i,createdAt:+new Date};p(a.tags,n)}}),function(t){let{onRemove:e}=t,i=h(v.items.list);i.addEventListener("click",t=>{let i=t.target.closest(E.itemRemove);if(i){let i=t.target.closest(E.item);e(Number(i.dataset.itemId))}})}({onRemove:t=>{let e=u[a.items],i=e.find(e=>e.id===t);b(a.items,i)}}),function(t){let{onRemove:e}=t,i=h(v.tags.list);i.addEventListener("click",t=>{let i=t.target.closest(L.tagRemove);if(i){let i=t.target.closest(L.tag);e(Number(i.dataset.tagId))}})}({onRemove:t=>{let e=u[a.tags],i=e.find(e=>e.id===t),n=u[a.items],o=n.some(t=>t.tag===i.id||t.subitems.some(t=>t.tag===i.id));if(o){m("Тег нельзя удалить");return}b(a.tags,i)}});//# sourceMappingURL=index.4fb923eb.js.map

//# sourceMappingURL=index.4fb923eb.js.map
