!function(){let e;let t="items",i="tags",o="periods";function r(t,i){return e.result.transaction(t,i?"readwrite":"readonly").objectStore(t)}async function n(){return new Promise(e=>{let t=r(i),o=t.getAll();o.onsuccess=function(){let t=o.result;e(t)}})}async function a(){return new Promise(e=>{let t=r(o),i=t.getAll();i.onsuccess=function(){let t=i.result;e(t)}})}async function s(){return new Promise(s=>{(e=indexedDB.open("wallet",4)).onupgradeneeded=function(){let r=e.result;r.objectStoreNames.contains(t)||r.createObjectStore(t,{keyPath:"id"}),r.objectStoreNames.contains(i)||r.createObjectStore(i,{keyPath:"id"}),r.objectStoreNames.contains(o)||r.createObjectStore(o,{keyPath:"id"})},e.onerror=function(){console.error("DB ERROR",e.error)},e.onsuccess=function(){Promise.all([n(),new Promise(e=>{let i=r(t),o=i.getAll();o.onsuccess=function(){let t=o.result;e(t)}}),a()]).then(([e,t,i])=>{s({tags:e,items:t,periods:i})})}})}function d(e,t){alert(e),console.info(e,t)}function l(e,t){alert(e),console.error(e,t)}function m(e){let t=r(o,!0),i=t.add(e);i.onsuccess=function(){d("Запись успешно сохранена")},i.onerror=function(){l("Не удалось сохранить запись",i.error)}}let u={items:"items",tags:"tags",periods:"periods",activePeriod:"activePeriod"},c={update:"update",add:"add",remove:"remove"},g={items:[],tags:[],periods:[],activePeriod:null},p={items:0,tags:0,periods:0},f={};function b(){let e=g.activePeriod;if(!e)return g.items;let t=g.periods.findIndex(t=>t.id===e.id),i=g.periods[t+1];return g.items.filter(t=>(!e.createdAt||!(t.createdAt<e.createdAt))&&(!i||!(t.createdAt>=i.createdAt)))}function v(e,t,i){let o=f[e];if(!o)return;let r=o[t];r&&r.forEach(e=>e(i))}function h(e,t,i){e in f||(f[e]={}),t in f[e]||(f[e][t]=[]),f[e][t].push(i)}function S(e,t){g[e].push(t),v(e,c.add,t)}function x(e,t){g[e]=g[e].filter(e=>e.id!==t.id),v(e,c.remove,t)}function E(e){g.activePeriod=e,v(u.activePeriod,c.update,e)}let y={items:{list:"items",template:"item-tmpl",subitemTemplate:"subitem-tmpl"},itemForm:{dialog:"new-item-dialog",form:"new-item-form",addButton:"add-item",closeButton:"close-new-item-dialog",subitemsList:"new-item-form-subitems",tagsSelect:"tags-select",addSubitemBtn:"new-item-add-subitem",subitemTemplate:"subitem-form-tmpl"},tags:{list:"tags",template:"tag-tmpl",aside:"tags-sidebar",toggleListBtn:"tags-toggle"},tagForm:{dialog:"new-tag-dialog",form:"new-tag-form",addButton:"add-tag",closeButton:"close-new-tag-dialog"},periods:{toggleButton:"periods-toggle",startButton:"start-period",aside:"periods-sidebar",list:"periods-list",periodTemplate:"period-tmpl"}},A={};function F(e){if(A[e])return A[e];let t=document.getElementById(e);return A[e]=t,t}function w(e){let t=F(e),i=t.content.cloneNode(!0);return i}function L(e){let t=document.createElement("option");return t.textContent=e.name,t.value=e.id,t}function C(){let e=F(y.itemForm.tagsSelect);e.innerHTML="";let t=[...g[u.tags]],i=function(){let e=function(){let e=[];return g.items.forEach(t=>{e.push(t),e.push(...t.subitems)}),e}(),t={};return g.tags.forEach(e=>{t[e.id]=0}),e.forEach(e=>{t[e.tag]+=1}),t}();t.sort((e,t)=>i[t.id]-i[e.id]),t.forEach(t=>{let i=L(t);e.appendChild(i)})}function P(){let e=F(y.itemForm.dialog);e.close(),function(){let e=F(y.itemForm.form),t=F(y.itemForm.subitemsList);e.reset(),t.innerHTML=""}()}let B={item:".item",itemText:".item-text",itemPrice:".item-price",itemTag:".item-tag",itemRemove:".item-remove",subitems:".item-subitems",subitem:".subitem",subitemText:".subitem-text",subitemPrice:".subitem-price",subitemTag:".subitem-tag"};function q(e){let t=w(y.items.template),i=t.querySelector(B.item);i.dataset.itemId=e.id,i.querySelector(B.itemText).textContent=e.text,i.querySelector(B.itemPrice).textContent=e.price;let o=g[u.tags],r=o.find(t=>t.id===e.tag);if(i.querySelector(B.itemTag).textContent=r?.name||"",e.subitems?.length>0){let t=i.querySelector(B.subitems);e.subitems.forEach(e=>{let i=function(e){let t=w(y.items.subitemTemplate),i=t.querySelector(B.subitem);i.querySelector(B.subitemText).textContent=e.text,i.querySelector(B.subitemPrice).textContent=e.price;let o=g[u.tags],r=o.find(t=>t.id===e.tag);return i.querySelector(B.subitemTag).textContent=r?.name||"",i}(e);t.appendChild(i)})}return i}function T(e){let t=F(y.items.list);t.innerHTML="",e.forEach(e=>{let i=q(e);t.appendChild(i)})}function k(e){return`${e.getDate()}.${e.getMonth()+1}.${e.getFullYear()}`}let R={period:".period",periodStart:".period-start",periodEnd:".period-end",periodRemove:".period-remove"};function D(e,t){let i=w(y.periods.periodTemplate),o=i.querySelector(R.period);o.dataset.periodId=e.id;let r=new Date(e.createdAt),n=t?new Date(t.createdAt):null;return o.querySelector(R.periodStart).textContent=`с ${k(r)}`,o.querySelector(R.periodEnd).textContent=n?`по ${k(n)}`:"...",o}function N(){let e=F(y.tagForm.dialog);e.close(),function(){let e=F(y.tagForm.form);e.reset()}()}let I={tag:".tag",tagName:".tag-name",tagRemove:".tag-remove"};function $(e){let t=w(y.tags.template),i=t.querySelector(I.tag);return i.dataset.tagId=e.id,i.querySelector(I.tagName).textContent=e.name,i}// Subscriptions
h(u.tags,c.update,e=>{(function(e){let t=F(y.tags.list);e.forEach(e=>{let i=$(e);t.appendChild(i)})})(e),C()}),h(u.tags,c.add,e=>{let t;(function(e){let t=F(y.tags.list),i=$(e);t.appendChild(i)})(e),N(),C(),(t=r(i,!0).add(e)).onsuccess=function(){d("Запись успешно сохранена")},t.onerror=function(){l("Не удалось сохранить запись",t.error)}}),h(u.tags,c.remove,e=>{let t;(function(e){let t=document.querySelector(`[data-tag-id="${e}"]`);t.remove()})(e.id),C(),(t=r(i,!0).delete(e.id)).onsuccess=function(){d("Запись успешно удалена")},t.onerror=function(){l("Не удалось удалить запись",t.error)}}),h(u.items,c.update,e=>{let t=b();T(t),C()}),h(u.items,c.add,e=>{(function(e){let t=q(e),i=F(y.items.list);i.appendChild(t)})(e),P(),function(e){let i=r(t,!0),o=i.add(e);o.onsuccess=function(){d("Запись успешно сохранена")},o.onerror=function(){l("Не удалось сохранить запись",o.error)}}(e),C()}),h(u.items,c.remove,e=>{let i;(function(e){let t=document.querySelector(`[data-item-id="${e}"]`);t.remove()})(e.id),(i=r(t,!0).delete(e.id)).onsuccess=function(){d("Запись успешно удалена")},i.onerror=function(){l("Не удалось удалить запись",i.error)},C()}),h(u.periods,c.update,e=>{!function(e){let t=F(y.periods.list);t.innerHTML="",e.forEach((i,o)=>{let r=D(i,e[o+1]);t.appendChild(r)})}(e)}),h(u.periods,c.add,e=>{(function(e){let t=F(y.periods.list),i=D(e);t.appendChild(i)})(e),m(e),E(e)}),h(u.activePeriod,c.update,e=>{let t=b();T(t)}),s().then(({tags:e,items:t,periods:i})=>{if(0===i.length){let e={id:0,createdAt:null};i.push(e),m(e)}!function({tags:e,items:t,periods:i}){if(e.length>0&&(p.tags=e[e.length-1].id,g.tags=e),t.length>0&&(p.items=t[t.length-1].id,g.items=t),i.length>0){let e=i[i.length-1];p.periods=e.id,g.periods=i,g.activePeriod=e}v(u.tags,c.update,e),v(u.items,c.update,t),v(u.periods,c.update,i)}({tags:e,items:t,periods:i})}),function(e){let{onSubmit:t}=e,i=F(y.itemForm.form),o=F(y.itemForm.addButton),r=F(y.itemForm.closeButton),n=F(y.itemForm.addSubitemBtn),a=F(y.itemForm.subitemsList);i.addEventListener("submit",e=>{e.preventDefault(),t(function(){let e=F(y.itemForm.form),t=new FormData(e),i=t.getAll("subitems[text][]"),o=t.getAll("subitems[price][]"),r=t.getAll("subitems[tag][]");return{text:t.get("text"),price:t.get("price"),tag:Number(t.get("tag")),subitems:i.map((e,t)=>({text:e,price:o[t],tag:Number(r[t])}))}}())}),o.addEventListener("click",()=>{!function(){let e=F(y.itemForm.dialog);e.showModal()}()}),r.addEventListener("click",()=>{P()}),n.addEventListener("click",()=>{let e=function(){let e=w(y.itemForm.subitemTemplate),t=e.querySelector(".subitem-form"),i=t.querySelector("select"),o=g[u.tags];return o.forEach(e=>{let t=L(e);i.appendChild(t)}),t}();a.appendChild(e)})}({onSubmit:e=>{var t;let{text:i,price:o,tag:r,subitems:n}=e,a=+new Date,s={id:(t=u.items,++p[t]),text:i,price:o,tag:r,createdAt:a,subitems:n.map(e=>{var t;return{id:(t=u.items,++p[t]),text:e.text,price:e.price,tag:e.tag,createdAt:a}})};S(u.items,s)}}),function(e){let{onSubmit:t}=e,i=F(y.tagForm.form),o=F(y.tagForm.addButton),r=F(y.tagForm.closeButton);i.addEventListener("submit",e=>{e.preventDefault();let i=function(){let e=F(y.tagForm.form);return{name:e.elements.name.value}}();if(!i.name){l("Не заполнено поле name",{formData:i});return}let o=g[u.tags],r=o.some(e=>e.name===i.name);if(r){l(`Тег с именем ${i.name} уже добавлен`,{formData:i});return}t(i)}),o.addEventListener("click",()=>{!function(){let e=F(y.tagForm.dialog);e.showModal()}()}),r.addEventListener("click",()=>{N()})}({onSubmit:e=>{var t;let{name:i}=e,o={id:(t=u.tags,++p[t]),name:i,createdAt:+new Date};S(u.tags,o)}}),function(e){let{onRemove:t}=e,i=F(y.items.list);i.addEventListener("click",e=>{let i=e.target.closest(B.itemRemove);if(i){let i=e.target.closest(B.item);t(Number(i.dataset.itemId))}})}({onRemove:e=>{let t=g[u.items],i=t.find(t=>t.id===e);x(u.items,i)}}),function(e){let{onRemove:t}=e,i=F(y.tags.list);i.addEventListener("click",e=>{let i=e.target.closest(I.tagRemove);if(i){let i=e.target.closest(I.tag);t(Number(i.dataset.tagId))}});let o=F(y.tags.toggleListBtn),r=F(y.tags.aside);o.addEventListener("click",()=>{r.hasAttribute("data-open")?r.removeAttribute("data-open"):r.setAttribute("data-open","true")})}({onRemove:e=>{let t=g[u.tags],i=t.find(t=>t.id===e),o=g[u.items],r=o.some(e=>e.tag===i.id||e.subitems.some(e=>e.tag===i.id));if(r){l("Тег нельзя удалить");return}x(u.tags,i)}}),function(e){let{onStart:t,onRemove:i,onSelect:o}=e,r=F(y.periods.toggleButton),n=F(y.periods.aside),a=F(y.periods.list),s=F(y.periods.startButton);r.addEventListener("click",()=>{n.hasAttribute("data-open")?n.removeAttribute("data-open"):n.setAttribute("data-open","true")}),a.addEventListener("click",e=>{let t=e.target.closest(R.periodRemove);if(t){let t=e.target.closest(R.period);i(Number(t.dataset.periodId));return}let r=e.target.closest(R.period);r&&(console.log("click",r.dataset.periodId),o(Number(r.dataset.periodId)))}),s.addEventListener("click",t)}({onStart:()=>{var e;let t={id:(e=u.periods,++p[e]),createdAt:+new Date};S(u.periods,t)},onRemove:e=>{let t=g[u.periods],i=t.find(t=>t.id===e);x(u.periods,i)},onSelect:e=>{let t=g[u.periods],i=t.find(t=>t.id===e);E(i)}})}();//# sourceMappingURL=index.e1dd3d2f.js.map

//# sourceMappingURL=index.e1dd3d2f.js.map
