// Constants
const e="items",t="tags";let n=[],o=[],r=0,l=0;// Elements
const c=document.getElementById("items"),i=document.getElementById("item-tmpl"),d=document.getElementById("new-item-dialog"),a=document.getElementById("new-item-form"),s=document.getElementById("add-item"),u=document.getElementById("close-new-item-dialog"),m=document.getElementById("tags"),g=document.getElementById("tag-tmpl"),f=document.getElementById("new-tag-dialog"),p=document.getElementById("new-tag-form"),y=document.getElementById("add-tag"),E=document.getElementById("close-new-tag-dialog"),b=document.getElementById("tags-select"),h=document.getElementById("new-item-form-subitems"),S=document.getElementById("new-item-add-subitem"),B=document.getElementById("subitem-form-tmpl"),w=document.getElementById("subitem-tmpl");// Render
function C(t){let r=i.content.cloneNode(!0),l=r.querySelector(".item");l.querySelector(".item-text").textContent=t.text,l.querySelector(".item-price").textContent=t.price;let c=o.find(e=>e.id===t.tag);if(l.querySelector(".item-tag").textContent=c?.name||"",l.querySelector(".item-remove").onclick=()=>{let o;n=n.filter(e=>e.id!==t.id),(o=j.result.transaction(e,"readwrite").objectStore(e).delete(t.id)).onsuccess=function(){alert("Запись успешно удалена")},o.onerror=function(){alert("Не удалось удалить запись"),console.error(o.error)},l.remove()},t.subitems?.length>0){let e=l.querySelector(".item-subitems");t.subitems.forEach(t=>{let n=function(e){let t=w.content.cloneNode(!0),n=t.querySelector(".subitem");n.querySelector(".subitem-text").textContent=e.text,n.querySelector(".subitem-price").textContent=e.price;let r=o.find(t=>t.id===e.tag);return n.querySelector(".subitem-tag").textContent=r?.name||"",n}(t);e.appendChild(n)})}return l}function I(e){let r=g.content.cloneNode(!0),l=r.querySelector(".tag");return l.querySelector(".tag-name").textContent=e.name,l.querySelector(".tag-remove").onclick=()=>{let r;let c=n.filter(t=>t.tag===e.id);if(c.length>0){alert("Тег нельзя удалить"),console.log({tagItems:c});return}o=o.filter(t=>t.id!==e.id),(r=j.result.transaction(t,"readwrite").objectStore(t).delete(e.id)).onsuccess=function(){alert("Запись успешно удалена")},r.onerror=function(){alert("Не удалось удалить запись"),console.error(r.error)},l.remove(),q()},l}function x(e){let t=document.createElement("option");return t.textContent=e.name,t.value=e.id,t}function q(){b.innerHTML="",o.forEach(e=>{let t=x(e);b.appendChild(t)})}function v(){a.reset(),h.innerHTML=""}// Database
const j=indexedDB.open("wallet",2);j.onupgradeneeded=function(){let n=j.result;n.objectStoreNames.contains(e)||n.createObjectStore(e,{keyPath:"id"}),n.objectStoreNames.contains(t)||n.createObjectStore(t,{keyPath:"id"})},j.onerror=function(){console.error("DB ERROR",j.error)},j.onsuccess=function(){let i=j.result,d=i.transaction(t).objectStore(t),a=d.getAll();a.onsuccess=function(){let t=a.result;t.length>0&&(l=t[t.length-1].id),(o=t).forEach(e=>{let t=I(e);m.appendChild(t)}),q();let d=i.transaction(e).objectStore(e),s=d.getAll();s.onsuccess=function(){let e=s.result;e.length>0&&(r=e[e.length-1].id),(n=e).forEach(e=>{let t=C(e);c.appendChild(t)})}}},// DOM
a.addEventListener("submit",t=>{let o;t.preventDefault();let l=new FormData(a),i=l.getAll("subitems[text][]"),s=l.getAll("subitems[price][]"),u=l.getAll("subitems[tag][]"),m=+new Date,g={id:++r,text:l.get("text"),price:l.get("price"),tag:Number(l.get("tag")),createdAt:m,subitems:i.map((e,t)=>({id:++r,text:e,price:s[t],tag:Number(u[t]),createdAt:m}))};n.push(g);let f=C(g);c.appendChild(f),(o=j.result.transaction(e,"readwrite").objectStore(e).add(g)).onsuccess=function(){alert("Запись успешно сохранена")},o.onerror=function(){alert("Не удалось сохранить запись"),console.error(o.error)},v(),d.close()}),s.addEventListener("click",()=>{d.showModal()}),u.addEventListener("click",()=>{v(),d.close()}),p.addEventListener("submit",e=>{let n;e.preventDefault();let r={id:++l,name:p.elements.name.value,createdAt:+new Date};o.push(r);let c=I(r);m.appendChild(c);let i=x(r);b.appendChild(i),(n=j.result.transaction(t,"readwrite").objectStore(t).add(r)).onsuccess=function(){alert("Запись успешно сохранена")},n.onerror=function(){alert("Не удалось сохранить запись"),console.error(n.error)},p.reset(),f.close()}),y.addEventListener("click",()=>{f.showModal()}),E.addEventListener("click",()=>{p.reset(),f.close()}),S.addEventListener("click",()=>{let e=function(){let e=B.content.cloneNode(!0),t=e.querySelector(".subitem-form"),n=t.querySelector("select");return o.forEach(e=>{let t=x(e);n.appendChild(t)}),t}();h.appendChild(e)});//# sourceMappingURL=index.7852e41a.js.map

//# sourceMappingURL=index.7852e41a.js.map
