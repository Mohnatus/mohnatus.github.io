let e;const t="items",i="tags",o="periods";function r(t,i){return e.result.transaction(t,i?"readwrite":"readonly").objectStore(t)}async function n(){return new Promise(e=>{let t=r(i),o=t.getAll();o.onsuccess=function(){let t=o.result;e(t)}})}async function s(){return new Promise(e=>{let t=r(o),i=t.getAll();i.onsuccess=function(){let t=i.result;e(t)}})}async function a(){return new Promise(a=>{(e=indexedDB.open("wallet",4)).onupgradeneeded=function(){let r=e.result;r.objectStoreNames.contains(t)||r.createObjectStore(t,{keyPath:"id"}),r.objectStoreNames.contains(i)||r.createObjectStore(i,{keyPath:"id"}),r.objectStoreNames.contains(o)||r.createObjectStore(o,{keyPath:"id"})},e.onerror=function(){console.error("DB ERROR",e.error)},e.onsuccess=function(){Promise.all([n(),new Promise(e=>{let i=r(t),o=i.getAll();o.onsuccess=function(){let t=o.result;e(t)}}),s()]).then(([e,t,i])=>{a({tags:e,items:t,periods:i})})}})}function d(e,t){alert(e),console.info(e,t)}function l(e,t){alert(e),console.error(e,t)}const m={items:"items",tags:"tags",periods:"periods",activePeriod:"activePeriod"},c={update:"update",add:"add",remove:"remove"},u={items:[],tags:[],periods:[],activePeriod:null},g={items:0,tags:0,periods:0},p={};function f(){let e=u.activePeriod;if(!e)return u.items;let t=u.periods.findIndex(t=>t.id===e.id),i=u.periods[t+1];return console.log({period:e,periodIndex:t,nextPeriod:i,periods:u.periods,items:u.items}),u.items.filter(t=>!(t.createdAt<e.createdAt)&&(!i||!(t.createdAt>=i.createdAt)))}function b(e,t,i){let o=p[e];if(!o)return;let r=o[t];r&&r.forEach(e=>e(i))}function v(e,t,i){e in p||(p[e]={}),t in p[e]||(p[e][t]=[]),p[e][t].push(i)}function h(e,t){u[e].push(t),b(e,c.add,t)}function S(e,t){u[e]=u[e].filter(e=>e.id!==t.id),b(e,c.remove,t)}const x={items:{list:"items",template:"item-tmpl",subitemTemplate:"subitem-tmpl"},itemForm:{dialog:"new-item-dialog",form:"new-item-form",addButton:"add-item",closeButton:"close-new-item-dialog",subitemsList:"new-item-form-subitems",tagsSelect:"tags-select",addSubitemBtn:"new-item-add-subitem",subitemTemplate:"subitem-form-tmpl"},tags:{list:"tags",template:"tag-tmpl",aside:"tags-sidebar",toggleListBtn:"tags-toggle"},tagForm:{dialog:"new-tag-dialog",form:"new-tag-form",addButton:"add-tag",closeButton:"close-new-tag-dialog"},periods:{toggleButton:"periods-toggle",startButton:"start-period",aside:"periods-sidebar",list:"periods-list",periodTemplate:"period-tmpl"}},E={};function y(e){if(E[e])return E[e];let t=document.getElementById(e);return E[e]=t,t}function w(e){let t=y(e),i=t.content.cloneNode(!0);return i}function A(e){let t=document.createElement("option");return t.textContent=e.name,t.value=e.id,t}function F(){let e=y(x.itemForm.tagsSelect);e.innerHTML="";let t=[...u[m.tags]],i=function(){let e=function(){let e=[];return u.items.forEach(t=>{e.push(t),e.push(...t.subitems)}),e}(),t={};return u.tags.forEach(e=>{t[e.id]=0}),e.forEach(e=>{t[e.tag]+=1}),t}();t.sort((e,t)=>i[t.id]-i[e.id]),t.forEach(t=>{let i=A(t);e.appendChild(i)})}function P(){let e=y(x.itemForm.dialog);e.close(),function(){let e=y(x.itemForm.form),t=y(x.itemForm.subitemsList);e.reset(),t.innerHTML=""}()}const C={item:".item",itemText:".item-text",itemPrice:".item-price",itemTag:".item-tag",itemRemove:".item-remove",subitems:".item-subitems",subitem:".subitem",subitemText:".subitem-text",subitemPrice:".subitem-price",subitemTag:".subitem-tag"};function L(e){let t=w(x.items.template),i=t.querySelector(C.item);i.dataset.itemId=e.id,i.querySelector(C.itemText).textContent=e.text,i.querySelector(C.itemPrice).textContent=e.price;let o=u[m.tags],r=o.find(t=>t.id===e.tag);if(i.querySelector(C.itemTag).textContent=r?.name||"",e.subitems?.length>0){let t=i.querySelector(C.subitems);e.subitems.forEach(e=>{let i=function(e){let t=w(x.items.subitemTemplate),i=t.querySelector(C.subitem);i.querySelector(C.subitemText).textContent=e.text,i.querySelector(C.subitemPrice).textContent=e.price;let o=u[m.tags],r=o.find(t=>t.id===e.tag);return i.querySelector(C.subitemTag).textContent=r?.name||"",i}(e);t.appendChild(i)})}return i}function B(e){let t=y(x.items.list);e.forEach(e=>{let i=L(e);t.appendChild(i)})}function q(e){return`${e.getDate()}.${e.getMonth()+1}.${e.getFullYear()}`}const T={period:".period",periodStart:".period-start",periodEnd:".period-end",periodRemove:".period-remove"};function R(e,t){let i=w(x.periods.periodTemplate),o=i.querySelector(T.period);o.dataset.periodId=e.id;let r=new Date(e.createdAt),n=t?new Date(t.createdAt):null;return o.querySelector(T.periodStart).textContent=`с ${q(r)}`,o.querySelector(T.periodEnd).textContent=n?`по ${q(n)}`:"...",o}function k(){let e=y(x.tagForm.dialog);e.close(),function(){let e=y(x.tagForm.form);e.reset()}()}const D={tag:".tag",tagName:".tag-name",tagRemove:".tag-remove"};function N(e){let t=w(x.tags.template),i=t.querySelector(D.tag);return i.dataset.tagId=e.id,i.querySelector(D.tagName).textContent=e.name,i}// Subscriptions
v(m.tags,c.update,e=>{(function(e){let t=y(x.tags.list);e.forEach(e=>{let i=N(e);t.appendChild(i)})})(e),F()}),v(m.tags,c.add,e=>{let t;(function(e){let t=y(x.tags.list),i=N(e);t.appendChild(i)})(e),k(),F(),(t=r(i,!0).add(e)).onsuccess=function(){d("Запись успешно сохранена")},t.onerror=function(){l("Не удалось сохранить запись",t.error)}}),v(m.tags,c.remove,e=>{let t;(function(e){let t=document.querySelector(`[data-tag-id="${e}"]`);t.remove()})(e.id),F(),(t=r(i,!0).delete(e.id)).onsuccess=function(){d("Запись успешно удалена")},t.onerror=function(){l("Не удалось удалить запись",t.error)}}),v(m.items,c.update,e=>{let t=f();B(t),F()}),v(m.items,c.add,e=>{(function(e){let t=L(e),i=y(x.items.list);i.appendChild(t)})(e),P(),function(e){let i=r(t,!0),o=i.add(e);o.onsuccess=function(){d("Запись успешно сохранена")},o.onerror=function(){l("Не удалось сохранить запись",o.error)}}(e),F()}),v(m.items,c.remove,e=>{let i;(function(e){let t=document.querySelector(`[data-item-id="${e}"]`);t.remove()})(e.id),(i=r(t,!0).delete(e.id)).onsuccess=function(){d("Запись успешно удалена")},i.onerror=function(){l("Не удалось удалить запись",i.error)},F()}),v(m.periods,c.update,e=>{!function(e){let t=y(x.periods.list);e.forEach((i,o)=>{let r=R(i,e[o+1]);t.appendChild(r)})}(e)}),v(m.periods,c.add,e=>{(function(e){let t=y(x.periods.list),i=R(e);t.appendChild(i)})(e),function(e){let t=r(o,!0),i=t.add(e);i.onsuccess=function(){d("Запись успешно сохранена")},i.onerror=function(){l("Не удалось сохранить запись",i.error)}}(e)}),v(m.activePeriod,c.update,e=>{let t=f();B(t)}),a().then(({tags:e,items:t,periods:i})=>{if(function({tags:e,items:t,periods:i}){if(e.length>0){if(g.tags=e[e.length-1].id,u.tags=e,t.length>0&&(g.items=t[t.length-1].id,u.items=t),i.length>0){let e=i[i.length-1];g.periods=e.id,u.periods=i,u.activePeriod=e}b(m.tags,c.update,e),b(m.items,c.update,t),b(m.periods,c.update,i)}}({tags:e,items:t,periods:i}),0===i.length){let e={id:0,createdAt:+new Date};h(m.periods,e)}}),function(e){let{onSubmit:t}=e,i=y(x.itemForm.form),o=y(x.itemForm.addButton),r=y(x.itemForm.closeButton),n=y(x.itemForm.addSubitemBtn),s=y(x.itemForm.subitemsList);i.addEventListener("submit",e=>{e.preventDefault(),t(function(){let e=y(x.itemForm.form),t=new FormData(e),i=t.getAll("subitems[text][]"),o=t.getAll("subitems[price][]"),r=t.getAll("subitems[tag][]");return{text:t.get("text"),price:t.get("price"),tag:Number(t.get("tag")),subitems:i.map((e,t)=>({text:e,price:o[t],tag:Number(r[t])}))}}())}),o.addEventListener("click",()=>{!function(){let e=y(x.itemForm.dialog);e.showModal()}()}),r.addEventListener("click",()=>{P()}),n.addEventListener("click",()=>{let e=function(){let e=w(x.itemForm.subitemTemplate),t=e.querySelector(".subitem-form"),i=t.querySelector("select"),o=u[m.tags];return o.forEach(e=>{let t=A(e);i.appendChild(t)}),t}();s.appendChild(e)})}({onSubmit:e=>{var t;let{text:i,price:o,tag:r,subitems:n}=e,s=+new Date,a={id:(t=m.items,++g[t]),text:i,price:o,tag:r,createdAt:s,subitems:n.map(e=>{var t;return{id:(t=m.items,++g[t]),text:e.text,price:e.price,tag:e.tag,createdAt:s}})};h(m.items,a)}}),function(e){let{onSubmit:t}=e,i=y(x.tagForm.form),o=y(x.tagForm.addButton),r=y(x.tagForm.closeButton);i.addEventListener("submit",e=>{e.preventDefault();let i=function(){let e=y(x.tagForm.form);return{name:e.elements.name.value}}();if(!i.name){l("Не заполнено поле name",{formData:i});return}let o=u[m.tags],r=o.some(e=>e.name===i.name);if(r){l(`Тег с именем ${i.name} уже добавлен`,{formData:i});return}t(i)}),o.addEventListener("click",()=>{!function(){let e=y(x.tagForm.dialog);e.showModal()}()}),r.addEventListener("click",()=>{k()})}({onSubmit:e=>{var t;let{name:i}=e,o={id:(t=m.tags,++g[t]),name:i,createdAt:+new Date};h(m.tags,o)}}),function(e){let{onRemove:t}=e,i=y(x.items.list);i.addEventListener("click",e=>{let i=e.target.closest(C.itemRemove);if(i){let i=e.target.closest(C.item);t(Number(i.dataset.itemId))}})}({onRemove:e=>{let t=u[m.items],i=t.find(t=>t.id===e);S(m.items,i)}}),function(e){let{onRemove:t}=e,i=y(x.tags.list);i.addEventListener("click",e=>{let i=e.target.closest(D.tagRemove);if(i){let i=e.target.closest(D.tag);t(Number(i.dataset.tagId))}});let o=y(x.tags.toggleListBtn),r=y(x.tags.aside);o.addEventListener("click",()=>{r.hasAttribute("data-open")?r.removeAttribute("data-open"):r.setAttribute("data-open","true")})}({onRemove:e=>{let t=u[m.tags],i=t.find(t=>t.id===e),o=u[m.items],r=o.some(e=>e.tag===i.id||e.subitems.some(e=>e.tag===i.id));if(r){l("Тег нельзя удалить");return}S(m.tags,i)}}),function(e){let{onStart:t,onRemove:i,onSelect:o}=e,r=y(x.periods.toggleButton),n=y(x.periods.aside),s=y(x.periods.list),a=y(x.periods.startButton);r.addEventListener("click",()=>{n.hasAttribute("data-open")?n.removeAttribute("data-open"):n.setAttribute("data-open","true")}),s.addEventListener("click",e=>{let t=e.target.closest(T.periodRemove);if(t){let t=e.target.closest(T.period);i(Number(t.dataset.periodId));return}let r=e.target.closest(T.period);r&&o(Number(r.dataset.periodId))}),a.addEventListener("click",t)}({onStart:()=>{var e;let t={id:(e=m.periods,++g[e]),createdAt:+new Date};h(m.periods,t)},onRemove:e=>{let t=u[m.periods],i=t.find(t=>t.id===e);S(m.periods,i)},onSelect:e=>{let t=u[m.periods],i=t.find(t=>t.id===e);u.activePeriod=i,b(m.activePeriod,c.update,i)}});//# sourceMappingURL=index.c9a0dee4.js.map

//# sourceMappingURL=index.c9a0dee4.js.map
