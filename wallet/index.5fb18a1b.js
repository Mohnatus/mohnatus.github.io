let e;function t(e,t){alert(e),console.info(e,t)}function i(e,t){alert(e),console.error(e,t)}const n="items",r="tags",o="periods";function a(t,i){return e.result.transaction(t,i?"readwrite":"readonly").objectStore(t)}async function s(){return new Promise(e=>{let t=a(r),i=t.getAll();i.onsuccess=function(){let t=i.result;e(t)}})}async function d(){return new Promise(e=>{let t=a(o),i=t.getAll();i.onsuccess=function(){let t=i.result;e(t)}})}async function l(){return new Promise(t=>{let l=indexedDB.open("wallet",4);l.onupgradeneeded=function(){let e=l.result;e.objectStoreNames.contains(n)||e.createObjectStore(n,{keyPath:"id"}),e.objectStoreNames.contains(r)||e.createObjectStore(r,{keyPath:"id"}),e.objectStoreNames.contains(o)||e.createObjectStore(o,{keyPath:"id"})},l.onerror=function(){i("DB ERROR",l.error)},l.onsuccess=function(){Promise.all([s(),new Promise(e=>{let t=a(n),i=t.getAll();i.onsuccess=function(){let t=i.result;e(t)}}),d()]).then(([e,i,n])=>{t({tags:e,items:i,periods:n})})},e=l})}function m(e){let n=a(o,!0),r=n.add(e);r.onsuccess=function(){t("Запись успешно сохранена")},r.onerror=function(){i("Не удалось сохранить запись",r.error)}}const c={};function u(e,t){e in c||(c[e]=[]),c[e].push(t)}function g(e,t){let i=c[e];i&&i.forEach(e=>e(t))}const f={inited:"store/inited",addItem:"item/add",removeItem:"item/remove",addTag:"tag/add",removeTag:"tag/remove",addPeriod:"period/add",removePeriod:"period/remove",setActivePeriod:"activePeriod/set"},p={items:"items",periods:"periods",tags:"tags"},b={};function v(e){return e in b||(b[e]=0),++b[e]}const h={items:[],tags:[],periods:[],activePeriod:null};function S(){return{...h}}function x(e){h.activePeriod=e,g(f.setActivePeriod,e)}function E(){let e=[];return S().items.forEach(t=>{e.push(t),e.push(...t.subitems)}),e}function A(){let e=S(),t=e.activePeriod;if(!t)return[...e.items];let i=e.periods.findIndex(e=>e.id===t.id),n=e.periods[i+1];return e.items.filter(e=>(!t.createdAt||!(e.createdAt<t.createdAt))&&(!n||!(e.createdAt>=n.createdAt)))}function P(){return S().periods}function T(e){let t=P();return t.find(t=>t.id===e)}function y(){return[...S().tags]}function F(e){let t=y();return t.find(t=>t.id===e)}function L(){let e=y(),t=function(){let e=S(),t=E(),i={};return e.tags.forEach(e=>{i[e.id]=0}),t.forEach(e=>{i[e.tag]+=1}),i}();return e.sort((e,i)=>t[i.id]-t[e.id]),e}const w={items:{list:"items",template:"item-tmpl",subitemTemplate:"subitem-tmpl"},itemForm:{dialog:"new-item-dialog",form:"new-item-form",addButton:"add-item",closeButton:"close-new-item-dialog",subitemsList:"new-item-form-subitems",tagsSelect:"tags-select",addSubitemBtn:"new-item-add-subitem",subitemTemplate:"subitem-form-tmpl"},tags:{list:"tags",template:"tag-tmpl",aside:"tags-sidebar",toggleListBtn:"tags-toggle"},tagForm:{dialog:"new-tag-dialog",form:"new-tag-form",addButton:"add-tag",closeButton:"close-new-tag-dialog"},periods:{toggleButton:"periods-toggle",startButton:"start-period",aside:"periods-sidebar",list:"periods-list",periodTemplate:"period-tmpl"}},C={};function B(e){if(C[e])return C[e];let t=document.getElementById(e);return C[e]=t,t}function q(e){let t=B(e),i=t.content.cloneNode(!0);return i}function I(e){let t=document.createElement("option");return t.textContent=e.name,t.value=e.id,t}function R(){let e=B(w.itemForm.dialog);e.close(),function(){let e=B(w.itemForm.form),t=B(w.itemForm.subitemsList);e.reset(),t.innerHTML=""}()}function k(){let e=B(w.tagForm.dialog);e.close(),function(){let e=B(w.tagForm.form);e.reset()}()}const D={item:".item",itemText:".item-text",itemPrice:".item-price",itemTag:".item-tag",itemRemove:".item-remove",subitems:".item-subitems",subitem:".subitem",subitemText:".subitem-text",subitemPrice:".subitem-price",subitemTag:".subitem-tag"};function N(e){let t=q(w.items.template),i=t.querySelector(D.item);i.dataset.itemId=e.id,i.querySelector(D.itemText).textContent=e.text,i.querySelector(D.itemPrice).textContent=e.price;let n=F(e.tag);if(i.querySelector(D.itemTag).textContent=n?.name||"",e.subitems?.length>0){let t=i.querySelector(D.subitems);e.subitems.forEach(e=>{let i=function(e){let t=q(w.items.subitemTemplate),i=t.querySelector(D.subitem);i.querySelector(D.subitemText).textContent=e.text,i.querySelector(D.subitemPrice).textContent=e.price;let n=F(e.tag);return i.querySelector(D.subitemTag).textContent=n?.name||"",i}(e);t.appendChild(i)})}return i}function M(e){let t=B(w.items.list);t.innerHTML="",e.forEach(e=>{let i=N(e);t.appendChild(i)})}const j={tag:".tag",tagName:".tag-name",tagRemove:".tag-remove"};function $(e){let t=q(w.tags.template),i=t.querySelector(j.tag);return i.dataset.tagId=e.id,i.querySelector(j.tagName).textContent=e.name,i}function H(e){return`${e.getDate()}.${e.getMonth()+1}.${e.getFullYear()}`}const O={period:".period",periodStart:".period-start",periodEnd:".period-end",periodRemove:".period-remove"};function Y(e,t){let i=q(w.periods.periodTemplate),n=i.querySelector(O.period);n.dataset.periodId=e.id;let r=new Date(e.createdAt),o=t?new Date(t.createdAt):null;return n.querySelector(O.periodStart).textContent=`с ${H(r)}`,n.querySelector(O.periodEnd).textContent=o?`по ${H(o)}`:"...",n}function z(){!function(e){let t=B(w.itemForm.tagsSelect);t.innerHTML="",e.forEach(e=>{let i=I(e);t.appendChild(i)})}(L())}u(f.inited,()=>{(function(e){let t=B(w.tags.list);t.innerHTML="",e.forEach(e=>{let i=$(e);t.appendChild(i)})})(y()),M(A()),function(e){let t=B(w.periods.list);t.innerHTML="",e.forEach((i,n)=>{let r=Y(i,e[n+1]);t.appendChild(r)})}(P()),S().activePeriod,z()}),u(f.addItem,e=>{(function(e){let r=a(n,!0),o=r.add(e);o.onsuccess=function(){t("Запись успешно сохранена")},o.onerror=function(){i("Не удалось сохранить запись",o.error)}})(e),function(e){let t=N(e),i=B(w.items.list);i.appendChild(t)}(e),R(),z()}),u(f.addTag,e=>{let n;(n=a(r,!0).add(e)).onsuccess=function(){t("Запись успешно сохранена")},n.onerror=function(){i("Не удалось сохранить запись",n.error)},function(e){let t=B(w.tags.list),i=$(e);t.appendChild(i)}(e),k(),z()}),u(f.addPeriod,e=>{m(e),function(e){let t=B(w.periods.list),i=Y(e);t.appendChild(i)}(e),x(e)}),u(f.removeTag,e=>{let n;(n=a(r,!0).delete(e.id)).onsuccess=function(){t("Запись успешно удалена")},n.onerror=function(){i("Не удалось удалить запись",n.error)},removeTagFromList(e.id),z()}),u(f.removeItem,e=>{let r;(r=a(n,!0).delete(e.id)).onsuccess=function(){t("Запись успешно удалена")},r.onerror=function(){i("Не удалось удалить запись",r.error)},function(e){let t=document.querySelector(`[data-item-id="${e}"]`);t.remove()}(e.id),z()}),u(f.setActivePeriod,e=>{M(A())}),l().then(({tags:e,items:t,periods:i})=>{if(0===i.length){let e={id:0,createdAt:null};i.push(e),m(e)}!function({tags:e,items:t,periods:i}){var n,r,o,a,s,d;if(e.length>0&&(n=p.tags,r=e[e.length-1].id,b[n]=r,h.tags=e),t.length>0&&(o=p.items,a=t[t.length-1].id,b[o]=a,h.items=t),i.length>0){let e=i[i.length-1];s=p.periods,d=e.id,b[s]=d,h.periods=i,h.activePeriod=e}g(f.inited,h)}({tags:e,items:t,periods:i})}),function(e){let{onSubmit:t}=e,i=B(w.itemForm.form),n=B(w.itemForm.addButton),r=B(w.itemForm.closeButton),o=B(w.itemForm.addSubitemBtn),a=B(w.itemForm.subitemsList);i.addEventListener("submit",e=>{e.preventDefault(),t(function(){let e=B(w.itemForm.form),t=new FormData(e),i=t.getAll("subitems[text][]"),n=t.getAll("subitems[price][]"),r=t.getAll("subitems[tag][]");return{text:t.get("text"),price:t.get("price"),tag:Number(t.get("tag")),subitems:i.map((e,t)=>({text:e,price:n[t],tag:Number(r[t])}))}}())}),n.addEventListener("click",()=>{!function(){let e=B(w.itemForm.dialog);e.showModal()}()}),r.addEventListener("click",()=>{R()}),o.addEventListener("click",()=>{let e=function(){let e=q(w.itemForm.subitemTemplate),t=e.querySelector(".subitem-form"),i=t.querySelector("select"),n=L();return n.forEach(e=>{let t=I(e);i.appendChild(t)}),t}();a.appendChild(e)})}({onSubmit:e=>{let{text:t,price:i,tag:n,subitems:r}=e,o=+new Date,a={id:v(p.items),text:t,price:i,tag:n,createdAt:o,subitems:r.map(e=>({id:v(p.items),text:e.text,price:e.price,tag:e.tag,createdAt:o}))};h.items.push(a),g(f.addItem,a)}}),function(e){let{onSubmit:t}=e,n=B(w.tagForm.form),r=B(w.tagForm.addButton),o=B(w.tagForm.closeButton);n.addEventListener("submit",e=>{e.preventDefault();let n=function(){let e=B(w.tagForm.form);return{name:e.elements.name.value}}();if(!n.name){i("Не заполнено поле name",{formData:n});return}let r=y(),o=r.some(e=>e.name===n.name);if(o){i(`Тег с именем ${n.name} уже добавлен`,{formData:n});return}t(n)}),r.addEventListener("click",()=>{!function(){let e=B(w.tagForm.dialog);e.showModal()}()}),o.addEventListener("click",()=>{k()})}({onSubmit:e=>{let{name:t}=e,i={id:v(p.tags),name:t,createdAt:+new Date};h.tags.push(i),g(f.addTag,i)}}),function(e){let{onRemove:t}=e,i=B(w.items.list);i.addEventListener("click",e=>{let i=e.target.closest(D.itemRemove);if(i){let i=e.target.closest(D.item);t(Number(i.dataset.itemId))}})}({onRemove:e=>{let t=function(e){let t=[...S().items];return t.find(t=>t.id===e)}(e);h.items=h.items.filter(e=>e.id!==t.id),g(f.removeItem,t)}}),function(e){let{onRemove:t}=e,i=B(w.tags.list);i.addEventListener("click",e=>{let i=e.target.closest(j.tagRemove);if(i){let i=e.target.closest(j.tag);t(Number(i.dataset.tagId))}});let n=B(w.tags.toggleListBtn),r=B(w.tags.aside);n.addEventListener("click",()=>{r.hasAttribute("data-open")?r.removeAttribute("data-open"):r.setAttribute("data-open","true")})}({onRemove:e=>{let t=F(e),n=function(e){let t=E();return t.filter(t=>t.tag===e)}(e);if(n.length){i("Тег нельзя удалить");return}h.tags=h.tags.filter(e=>e.id!==t.id),g(f.removeTag,t)}}),function(e){let{onStart:t,onRemove:i,onSelect:n}=e,r=B(w.periods.toggleButton),o=B(w.periods.aside),a=B(w.periods.list),s=B(w.periods.startButton);r.addEventListener("click",()=>{o.hasAttribute("data-open")?o.removeAttribute("data-open"):o.setAttribute("data-open","true")}),a.addEventListener("click",e=>{let t=e.target.closest(O.periodRemove);if(t){let t=e.target.closest(O.period);i(Number(t.dataset.periodId));return}let r=e.target.closest(O.period);r&&n(Number(r.dataset.periodId))}),s.addEventListener("click",t)}({onStart:()=>{let e={id:v(p.periods),createdAt:+new Date};h.periods.push(e),g(f.addPeriod,e)},onRemove:e=>{let t=T(e);h.periods=h.items.filter(e=>e.id!==t.id),g(f.removePeriod,t)},onSelect:e=>{let t=T(e);x(t)}});//# sourceMappingURL=index.5fb18a1b.js.map

//# sourceMappingURL=index.5fb18a1b.js.map
