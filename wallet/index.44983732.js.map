{"mappings":"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","sources":["src/script.js"],"sourcesContent":["// Constants\nconst DB_NAME = \"wallet\";\nconst DB_VERSION = 2;\nconst ITEMS_STORE_NAME = \"items\";\nconst TAGS_STORE_NAME = \"tags\";\n\nlet items = [];\nlet tags = [];\n\nlet lastItemId = 0;\nlet lastTagId = 0;\n\n// Elements\nconst $itemsList = document.getElementById(\"items\");\nconst $itemTemplate = document.getElementById(\"item-tmpl\");\nconst $newItemDialog = document.getElementById(\"new-item-dialog\");\nconst $newItemForm = document.getElementById(\"new-item-form\");\nconst $addItemBtn = document.getElementById(\"add-item\");\nconst $closeNewItemDialogBtn = document.getElementById(\n  \"close-new-item-dialog\"\n);\nconst $tagsList = document.getElementById(\"tags\");\nconst $tagTemplate = document.getElementById(\"tag-tmpl\");\nconst $newTagDialog = document.getElementById(\"new-tag-dialog\");\nconst $newTagForm = document.getElementById(\"new-tag-form\");\nconst $addTagBtn = document.getElementById(\"add-tag\");\nconst $closeNewTagDialogBtn = document.getElementById(\n  \"close-new-tag-dialog\"\n);\nconst $tagsSelect = document.getElementById(\"tags-select\");\nconst $newItemFormSubitemsList = document.getElementById(\n  \"new-item-form-subitems\"\n);\nconst $newItemAddSubitemBtn = document.getElementById(\n  \"new-item-add-subitem\"\n);\nconst $subitemFormTemplate = document.getElementById(\"subitem-form-tmpl\");\nconst $subitemTemplate = document.getElementById(\"subitem-tmpl\");\n\n// Render\nfunction renderItem(item) {\n  const $clone = $itemTemplate.content.cloneNode(true);\n  const $item = $clone.querySelector(\".item\");\n  $item.querySelector(\".item-text\").textContent = item.text;\n  $item.querySelector(\".item-price\").textContent = item.price;\n  const itemTag = tags.find((tag) => tag.id === item.tag);\n  $item.querySelector(\".item-tag\").textContent = itemTag?.name || \"\";\n  $item.querySelector(\".item-remove\").onclick = () => {\n    items = items.filter((i) => i.id !== item.id);\n    removeItemFromDb(item);\n    $item.remove();\n  };\n  if (item.subitems?.length > 0) {\n    const $subitemsList = $item.querySelector(\".item-subitems\");\n    item.subitems.forEach((subitem) => {\n      const $subitem = renderSubitem(subitem);\n      $subitemsList.appendChild($subitem);\n    });\n  }\n\n  return $item;\n}\nfunction renderItems() {\n  items.forEach((item) => {\n    const $item = renderItem(item);\n    $itemsList.appendChild($item);\n  });\n}\nfunction renderSubitemForm() {\n  const $clone = $subitemFormTemplate.content.cloneNode(true);\n  const $subitem = $clone.querySelector(\".subitem-form\");\n  const $subitemSelect = $subitem.querySelector(\"select\");\n  tags.forEach((tag) => {\n    const $tag = renderTagOption(tag);\n    $subitemSelect.appendChild($tag);\n  });\n  return $subitem;\n}\nfunction renderSubitem(subitem) {\n  const $clone = $subitemTemplate.content.cloneNode(true);\n  const $subitem = $clone.querySelector(\".subitem\");\n  $subitem.querySelector(\".subitem-text\").textContent = subitem.text;\n  $subitem.querySelector(\".subitem-price\").textContent = subitem.price;\n\n  const subitemTag = tags.find((tag) => tag.id === subitem.tag);\n  $subitem.querySelector(\".subitem-tag\").textContent =\n    subitemTag?.name || \"\";\n\n  return $subitem;\n}\n\nfunction renderTag(tag) {\n  const $clone = $tagTemplate.content.cloneNode(true);\n  const $tag = $clone.querySelector(\".tag\");\n  $tag.querySelector(\".tag-name\").textContent = tag.name;\n  $tag.querySelector(\".tag-remove\").onclick = () => {\n    const tagItems = items.filter((item) => item.tag === tag.id);\n    if (tagItems.length > 0) {\n      alert(\"Тег нельзя удалить\");\n      console.log({ tagItems });\n      return;\n    }\n    tags = tags.filter((t) => t.id !== tag.id);\n    removeTagFromDb(tag);\n    $tag.remove();\n    updateTagsSelect();\n  };\n  return $tag;\n}\nfunction renderTags() {\n  tags.forEach((tag) => {\n    const $tag = renderTag(tag);\n    $tagsList.appendChild($tag);\n  });\n}\n\nfunction renderTagOption(tag) {\n  const $option = document.createElement(\"option\");\n  $option.textContent = tag.name;\n  $option.value = tag.id;\n  return $option;\n}\nfunction updateTagsSelect() {\n  $tagsSelect.innerHTML = \"\";\n\n  tags.forEach((tag) => {\n    const $option = renderTagOption(tag);\n    $tagsSelect.appendChild($option);\n  });\n}\n\nfunction resetNewItemForm() {\n  $newItemForm.reset();\n  $newItemFormSubitemsList.innerHTML = \"\";\n}\n\n// Database\nconst dbRequest = indexedDB.open(DB_NAME, DB_VERSION);\ndbRequest.onupgradeneeded = function () {\n  let db = dbRequest.result;\n  if (!db.objectStoreNames.contains(ITEMS_STORE_NAME)) {\n    db.createObjectStore(ITEMS_STORE_NAME, { keyPath: \"id\" });\n  }\n  if (!db.objectStoreNames.contains(TAGS_STORE_NAME)) {\n    db.createObjectStore(TAGS_STORE_NAME, { keyPath: \"id\" });\n  }\n};\ndbRequest.onerror = function () {\n  console.error(\"DB ERROR\", dbRequest.error);\n};\ndbRequest.onsuccess = function () {\n  let db = dbRequest.result;\n  // Получить записи\n\n  let tagsTransaction = db.transaction(TAGS_STORE_NAME);\n  let tagsStore = tagsTransaction.objectStore(TAGS_STORE_NAME);\n\n  const tagsRequest = tagsStore.getAll();\n  tagsRequest.onsuccess = function () {\n    const result = tagsRequest.result;\n    if (result.length > 0) {\n      lastTagId = result[result.length - 1].id;\n    }\n\n    tags = result;\n    renderTags();\n    updateTagsSelect();\n\n    let itemsTransaction = db.transaction(ITEMS_STORE_NAME);\n    let itemsStore = itemsTransaction.objectStore(ITEMS_STORE_NAME);\n\n    const itemsRequest = itemsStore.getAll();\n    itemsRequest.onsuccess = function () {\n      const result = itemsRequest.result;\n      if (result.length > 0) {\n        lastItemId = result[result.length - 1].id;\n      }\n\n      items = result;\n      renderItems();\n    };\n  };\n};\nfunction addItemToDb(item) {\n  let db = dbRequest.result;\n  let transaction = db.transaction(ITEMS_STORE_NAME, \"readwrite\");\n  let items = transaction.objectStore(ITEMS_STORE_NAME);\n  let request = items.add(item);\n\n  request.onsuccess = function () {\n    alert(\"Запись успешно сохранена\");\n  };\n\n  request.onerror = function () {\n    alert(\"Не удалось сохранить запись\");\n    console.error(request.error);\n  };\n}\nfunction removeItemFromDb(item) {\n  let db = dbRequest.result;\n  let transaction = db.transaction(ITEMS_STORE_NAME, \"readwrite\");\n  let items = transaction.objectStore(ITEMS_STORE_NAME);\n  let request = items.delete(item.id);\n\n  request.onsuccess = function () {\n    alert(\"Запись успешно удалена\");\n  };\n\n  request.onerror = function () {\n    alert(\"Не удалось удалить запись\");\n    console.error(request.error);\n  };\n}\nfunction addTagToDb(tag) {\n  let db = dbRequest.result;\n  let transaction = db.transaction(TAGS_STORE_NAME, \"readwrite\");\n  let tags = transaction.objectStore(TAGS_STORE_NAME);\n  let request = tags.add(tag);\n\n  request.onsuccess = function () {\n    alert(\"Запись успешно сохранена\");\n  };\n\n  request.onerror = function () {\n    alert(\"Не удалось сохранить запись\");\n    console.error(request.error);\n  };\n}\nfunction removeTagFromDb(tag) {\n  let db = dbRequest.result;\n  let transaction = db.transaction(TAGS_STORE_NAME, \"readwrite\");\n  let tags = transaction.objectStore(TAGS_STORE_NAME);\n  let request = tags.delete(tag.id);\n\n  request.onsuccess = function () {\n    alert(\"Запись успешно удалена\");\n  };\n\n  request.onerror = function () {\n    alert(\"Не удалось удалить запись\");\n    console.error(request.error);\n  };\n}\n\n// DOM\n$newItemForm.addEventListener(\"submit\", (e) => {\n  e.preventDefault();\n  const fd = new FormData($newItemForm);\n\n  const subitemTexts = fd.getAll(\"subitems[text][]\");\n  const subitemPrices = fd.getAll(\"subitems[price][]\");\n  const subitemTags = fd.getAll(\"subitems[tag][]\");\n\n  const createdAt = +new Date();\n\n  const newItem = {\n    id: ++lastItemId,\n    text: fd.get(\"text\"),\n    price: fd.get(\"price\"),\n    tag: Number(fd.get(\"tag\")),\n    createdAt,\n\n    subitems: subitemTexts.map((text, i) => {\n      return {\n        id: ++lastItemId,\n        text,\n        price: subitemPrices[i],\n        tag: Number(subitemTags[i]),\n        createdAt,\n      };\n    }),\n  };\n  items.push(newItem);\n  const $item = renderItem(newItem);\n  $itemsList.appendChild($item);\n  addItemToDb(newItem);\n  resetNewItemForm();\n  $newItemDialog.close();\n});\n\n$addItemBtn.addEventListener(\"click\", () => {\n  $newItemDialog.showModal();\n});\n\n$closeNewItemDialogBtn.addEventListener(\"click\", () => {\n  resetNewItemForm();\n  $newItemDialog.close();\n});\n\n$newTagForm.addEventListener(\"submit\", (e) => {\n  e.preventDefault();\n  const newTag = {\n    id: ++lastTagId,\n    name: $newTagForm.elements.name.value,\n    createdAt: +new Date(),\n  };\n  tags.push(newTag);\n  const $tag = renderTag(newTag);\n  $tagsList.appendChild($tag);\n  const $tagOption = renderTagOption(newTag);\n  $tagsSelect.appendChild($tagOption);\n  addTagToDb(newTag);\n  $newTagForm.reset();\n  $newTagDialog.close();\n});\n\n$addTagBtn.addEventListener(\"click\", () => {\n  $newTagDialog.showModal();\n});\n\n$closeNewTagDialogBtn.addEventListener(\"click\", () => {\n  $newTagForm.reset();\n  $newTagDialog.close();\n});\n\n$newItemAddSubitemBtn.addEventListener(\"click\", () => {\n  const $subitemForm = renderSubitemForm();\n  $newItemFormSubitemsList.appendChild($subitemForm);\n});"],"names":[],"version":3,"file":"index.44983732.js.map","sourceRoot":"/__parcel_source_root/"}